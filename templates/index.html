{% extends "main_template.html" %}
{% block content %}
  <header>
    <ul id="header-nav">
      <li>
        <a href="{{ url_for('index') }}" id="head-main">
            <h1>Concept Insight Visualizer</h1>
            <p>for keyword exploration</p>
        </a>
      </li>
      <li>
        <ul id="nav">
          <li><a href="{{ url_for('about') }}">About Us</a></li>
        </ul>
      </li>
      <li id="more-wrapper">
        <b><a href="#">&#xF0C9;</a></b>
        <ul id="more-nav">
          <li>
            <ul class="subfilter"></ul>
          </li>
        </ul>
      </li>
    </ul>
  </header>
  <div id="flash-msg">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash{{ ' '+category }}"><a class="flash-message-closer" href="#" onclick="$(this).hide(400).parents('.flash').slideUp(400,function(){$(this).remove();});">&#xF05C;</a>{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>
  {% block body %}
    <div id="content">
      <div id="form-outer-wrapper">
        <div id="form-inner-wrapper">
        </div>
      </div>
    </div>
    <div id="qr-container"><aside>What&rsquo;s this?</aside><img src="{{ qrcode(about_url) }}"></div>
  {% endblock %}
  {% block footer_extra %}
    <script type="text/javascript" charset="utf-8">

      var more_colors = [
        "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd",
        "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"
      ];

      var data = [
          ['Alcalá de Henares','Barcelona',150],['Alcalá de Henares','Cuenca',100],['Alcalá de Henares','Denia',300],['Alcalá de Henares','Écija',500],['Alcalá de Henares','Fuenjirola',450],
          ['Barcelona','Alcalá de Henares',150],['Barcelona','Cuenca',250],['Barcelona','Denia',250],['Barcelona','Écija',800],['Barcelona','Fuenjirola',300],
          ['Cuenca','Alcalá de Henares',100],['Cuenca','Barcelona',250],['Cuenca','Denia',150],['Cuenca','Écija',250],['Cuenca','Fuenjirola',150],
          ['Denia','Alcalá de Henares',300],['Denia','Barcelona',250],['Denia','Cuenca',150],['Denia','Écija',400],['Denia','Fuenjirola',100],
          ['Écija','Alcalá de Henares',500],['Écija','Barcelona',800],['Écija','Cuenca',250],['Écija','Denia',400],['Écija','Fuenjirola',300],
          ['Fuenjirola','Alcalá de Henares',450],['Fuenjirola','Barcelona',300],['Fuenjirola','Cuenca',150],['Fuenjirola','Denia',100],['Fuenjirola','Écija',300]
      ];

      var colors = {
        "Alcalá de Henares": "#da4480",
        "Barcelona": "#5ab449",
        "Cuenca": "#7f5acd",
        "Denia": "#17becf",
        "Écija": "#bcbd22",
        "Fuenjirola": "#7f7f7f"
      };

      var sortOrder =[
        'Alcalá de Henares',
        'Barcelona',
        'Cuenca',
        'Denia',
        'Écija',
        'Fuenjirola'
      ];

      function sort(a,b){ return d3.ascending(sortOrder.indexOf(a),sortOrder.indexOf(b)); }
      var interval = Math.floor(1000 / 60 * 10);
      var resizeTimer;

      function render(){

          var height = parseInt($('#form-inner-wrapper').css('height'));
          var width = $(window).width()-30;
          var innerRadius = Math.min.apply(null,[height,$(window).width()])/2 - 100;
          var outerRadius = innerRadius + 10;

          $('#form-inner-wrapper').css('width', width);

          var last = d3.select('#form-inner-wrapper')._groups[0][0].firstChild;
          if(last != null){last.remove();}

          var ch = viz.ch().data(data)
            .padding(.033)
            .sort(sort)
            .innerRadius(innerRadius)
            .outerRadius(outerRadius)
            .duration(1000)
            .chordOpacity(0.3)
            .labelPadding(.15)
            .fill(function(d){ return colors[d];});

          var svg = d3.select('#form-inner-wrapper').append("svg").attr("height",height).attr("width",width);

          svg.append("g")
            .attr("transform", "translate(" + width/2 + "," + height/2 + ")")
            .call(ch);

          if(innerRadius<150){
              svg.selectAll('text').style("font-size",d3.scaleLinear().range([10,18]).domain([0,150])(innerRadius));
          }else{
              svg.selectAll('text').style("font-size",18);
          }

      }

      $(document).ready(function() {

        render();

        window.addEventListener('resize', function (event) {
          if (resizeTimer !== false) {
            clearTimeout(resizeTimer);
          }
          resizeTimer = setTimeout(function () {
            render()
          }, interval);
        });

        var i = 0;
        setInterval(function(){

          d3.select('g.groups:nth-child('+(i+1)+')').dispatch('mouseover');
          $('g.groups:nth-child('+(i+2)+')').find('text').css('font-weight','bold');
          setTimeout(function(){
            d3.select('g.groups:nth-child('+(i+1)+')').dispatch('mouseout');
            $('g.groups:nth-child('+(i+2)+')').find('text').css('font-weight','normal');
            i+=2;
            i%=$('g.groups').length;
          },4000);

        },6000);

      });
    </script>
  {% endblock %}
{% endblock %}